{% extends 'feeds/base.html' %}

{% load static %}

{% block content %}
<div class="container">
	<div class="card">
		<div class="card-header">
			<span class="icon is-small">
				<i class="fa fa-upload"></i>
			</span>
			<span>&nbsp;Import</span>
		</div>
		<div class="card-body" id="card">
			<div id="progress" class="progress mt-2 mb-4" style="display:none">
				<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-label="Animated striped example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
			</div>
			<table id="results" class="table table-striped table-hover table-is-responsive" style="display:none">
				<thead>
					<tr>
						<th>External URL</th>
						<th>Category</th>
						<th>Status</th>
						<th>URL</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>
</div>
{% endblock %}
{% block scripts %}
<script>
const card = document.getElementById("card");
const progress = document.getElementById("progress");
const progressBar = progress.firstElementChild;
const resultsSection = document.getElementById("results");

function getStatus(groupID, feeds) {
	fetch(`/task/group/${groupID}`, {
		method: 'GET',
		headers: {
			'Content-Type': 'application/json'
		},
	})
		.then(response => response.json())
		.then(resp => {

			let completedCount = 0;

			for (child of resp.children) {
				if (child.status === 'SUCCESS' || child.status === 'FAILURE') {
					completedCount++
				}
				feed = feeds.get(child.id);

				let URLRow = "..."
				if (child.status === 'SUCCESS') {
					URLRow = `<a href=${child.result.url}>${child.result.url}</a>`
				}

				let html = `
					<tr id="${child.id}">
					<td><a href=${feed.url}>${feed.url}</a></td>
					<td>${feed.category || "-"}</td>
					<td>${child.status}</td>
					<td>${URLRow}</td>
					</tr>`
				document.getElementById(child.id).innerHTML = html;
			}

			const percentageProgress = (completedCount / resp.children.length) * 100;
			console.log(completedCount, percentageProgress);
			progressBar.style.width = `${percentageProgress}%`
			progressBar.ariaValueNow = {percentageProgress}

			if (completedCount === resp.children.length)  {
				// TODO do we also want to display errors here?
				progressBar.classList.remove('animated');
				let alertSection = document.createElement("div");
			  alertSection.classList.add('alert', 'alert-success', 'fade', 'show', 'mt-3');
				alertSection.innerHTML = `Imported ${resp.completedCount} of ${resp.children.length}`;
				card.insertBefore(alertSection, card.firstChild);
				return
			}

			setTimeout(function() {
				getStatus(groupID, feeds);
			}, 1000);
		})
		.catch(err => console.log(err));
}

console.log('{{ data }}')
var resp = JSON.parse('{{ data | escapejs }}')

console.log(resp);

const feeds = new Map();
progress.style.display = '';
resultsSection.style.display = '';

for (task of resp.children) {
	feeds.set(task.id, {url: task.url, category: task.category}) ;
	let html = `
		<tr id="${task.id}">
			<td><a href=${task.url}>${task.url}</a></td>
			<td>${task.category || "-"}</td>
			<td>pending</td>
			<td>...</td>
		</tr>`
	let newrow = results.querySelector('tbody').insertRow(0);
	newrow.innerHTML = html;
	newrow.id = task.id;
}
getStatus(resp.id, feeds);
</script>
{% endblock %}
