{% extends 'feeds/base.html' %}

{% load static %}

{% block content %}
<div class="container">
	<div class="card">
		<div class="card-header">
			<span class="icon is-small">
				<i class="fa fa-upload"></i>
			</span>
			<span>&nbsp;Import</span>
		</div>
		<div class="card-body">
			<form method="post" id="file-upload-form">
				{% csrf_token %}
				<label for="id_file" class="form-label">Upload an <a href="http://opml.org/">OPML file:</a></label>
				<input class="form-control" type="file" id="id_file" name="file">
				<input class="mt-3 btn btn-success" type="submit" value="Submit" id="file-upload-button">
			</form>
			<table id="results" class="table table-striped table-hover table-is-responsive" style="display:none">
				<thead>
					<tr>
						<th>External URL</th>
						<th>Category</th>
						<th>Status</th>
						<th>URL</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>
</div>
{% endblock %}
{% block scripts %}
<script>
const fileInput = document.querySelector('input[type=file]');
function getStatus(groupID, feeds) {
	fetch(`/task/group/${groupID}`, {
		method: 'GET',
		headers: {
			'Content-Type': 'application/json'
		},
	})
		.then(response => response.json())
		.then(resp => {
			console.log(resp);
			for (child of resp.children) {
				feed = feeds.get(child.id);

				let URLRow = "..."
				console.log(child);
				if (child.status === 'SUCCESS') {
					console.log("made it here", child.result)
					URLRow = `<a href=${child.result.url}>${child.result.url}</a>`
				}

				let html = `
					<tr id="${child.id}">
					<td><a href=${feed.url}>${feed.url}</a></td>
					<td>${feed.category}</td>
					<td>${child.status}</td>
					<td>${URLRow}</td>
					</tr>`
				document.getElementById(child.id).innerHTML = html;
			}

			if (resp["completed_count"] === resp.children.length) {
				return
			}

			setTimeout(function() {
				getStatus(groupID, feeds);
			}, 1000);
		})
		.catch(err => console.log(err));
}

const resultsSection = document.getElementById("results");
const form = document.getElementById("file-upload-form");
const submitButton = document.getElementById("file-upload-button");
form.addEventListener("submit", function(event) {
	event.preventDefault();
	// Disable the button
	formData = new FormData(event.target);
	formData.append('file', fileInput.files[0])
	submitButton.disabled = true;
	fetch(event.target.action, {
		method: 'POST',
		body: formData,
	}).then((resp) => {
		return resp.json();
	}).then((resp) => {
		const feeds = new Map();
		results.style.display = '';
		for (task of resp.children) {
			feeds.set(task.id, {url: task.url, category: task.category}) ;
			let html = `
				<tr id="${task.id}">
				  <td><a href=${task.url}>${task.url}</a></td>
				  <td>${task.category}</td>
				  <td>pending</td>
				  <td>...</td>
				</tr>`
			let newrow = results.querySelector('tbody').insertRow(0);
			newrow.innerHTML = html;
			newrow.id = task.id;
		}
		getStatus(resp.id, feeds);
	}).catch((error) => {
		alert(error)
	});
}, true);
</script>
{% endblock %}
